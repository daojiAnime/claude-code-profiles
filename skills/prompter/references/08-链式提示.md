# 链式复杂提示以获得更强性能

## 什么是链式提示？

链式提示（Prompt Chaining）是将复杂任务分解为多个简单步骤，每个步骤的输出作为下一步的输入，逐步完成整体目标。

## 为什么使用链式提示？

### 核心优势

1. **降低复杂度** - 大任务变小任务
2. **提高准确性** - 每步专注单一目标
3. **便于调试** - 容易定位问题环节
4. **提升可控性** - 每步可以验证和调整
5. **减少错误累积** - 及时发现和纠正偏差

### 对比示例

**❌ 单一复杂提示:**
```
分析这份销售数据，找出趋势，识别异常值，生成可视化图表，
并写一份包含洞察和建议的报告。
```
→ 太复杂，容易遗漏或出错

**✅ 链式提示:**
```
步骤 1: 清洗和验证数据
步骤 2: 计算关键统计指标
步骤 3: 识别趋势和异常
步骤 4: 生成可视化
步骤 5: 撰写分析报告
```
→ 清晰、可控、准确

## 基本模式

### 模式 1: 线性链式

每步依赖前一步的输出：

```
┌──────────┐    ┌──────────┐    ┌──────────┐
│  步骤 1  │ => │  步骤 2  │ => │  步骤 3  │
│ 数据清洗 │    │ 数据分析 │    │ 报告生成 │
└──────────┘    └──────────┘    └──────────┘
```

**示例:**
```xml
<!-- 步骤 1: 提取信息 -->
<step1>
从以下文本提取关键实体:
[文本内容]

输出格式: JSON
</step1>

<!-- 步骤 2: 使用步骤 1 的输出 -->
<step2>
基于以下实体数据，创建知识图谱:
[步骤 1 的 JSON 输出]

输出格式: 图节点和边的列表
</step2>

<!-- 步骤 3: 使用步骤 2 的输出 -->
<step3>
根据知识图谱，回答以下问题:
[步骤 2 的图谱输出]

问题: [具体问题]
</step3>
```

### 模式 2: 分支链式

前一步生成多个输出，分别处理：

```
              ┌──────────┐
         ┌──> │  分支 A  │
┌──────┐│     └──────────┘
│ 步骤1 ││     ┌──────────┐
└──────┘├──> │  分支 B  │
        │     └──────────┘
        └──> ┌──────────┐
             │  分支 C  │
             └──────────┘
```

**示例:**
```xml
<!-- 步骤 1: 分类 -->
<step1>
将以下客户反馈分类:
[反馈列表]

类别: 产品问题 | 服务问题 | 功能建议
</step1>

<!-- 步骤 2a: 处理产品问题 -->
<step2a>
对于产品问题类反馈:
[步骤 1 中的产品问题]

识别具体问题并评估严重程度
</step2a>

<!-- 步骤 2b: 处理服务问题 -->
<step2b>
对于服务问题类反馈:
[步骤 1 中的服务问题]

分析服务流程中的痛点
</step2b>

<!-- 步骤 2c: 处理功能建议 -->
<step2c>
对于功能建议类反馈:
[步骤 1 中的功能建议]

评估可行性和优先级
</step2c>
```

### 模式 3: 聚合链式

多个并行步骤的结果汇总：

```
┌──────────┐
│  步骤 1a │ ──┐
└──────────┘   │
               │   ┌──────────┐
┌──────────┐   ├──>│  汇总步骤│
│  步骤 1b │ ──┤   └──────────┘
└──────────┘   │
               │
┌──────────┐   │
│  步骤 1c │ ──┘
└──────────┘
```

**示例:**
```xml
<!-- 并行步骤 1a: 技术评估 -->
<step1a>
从技术角度评估这个产品方案:
[方案描述]
</step1a>

<!-- 并行步骤 1b: 市场评估 -->
<step1b>
从市场角度评估这个产品方案:
[方案描述]
</step1b>

<!-- 并行步骤 1c: 财务评估 -->
<step1c>
从财务角度评估这个产品方案:
[方案描述]
</step1c>

<!-- 步骤 2: 综合决策 -->
<step2>
基于以下评估结果，做出最终决策:

技术评估: [步骤 1a 结果]
市场评估: [步骤 1b 结果]
财务评估: [步骤 1c 结果]

给出 Go/No-Go 决定和理由
</step2>
```

## 实战示例

### 示例 1: 代码审查工作流

```xml
<!-- 步骤 1: 静态分析 -->
<step1>
<task>检查代码的基本质量</task>
<code>[代码内容]</code>

检查项:
- 命名规范
- 代码格式
- 注释完整性

输出: 问题列表 (JSON)
</step1>

<!-- 步骤 2: 逻辑审查 -->
<step2>
<task>审查代码逻辑和算法</task>
<code>[代码内容]</code>
<issues>[步骤 1 的输出]</issues>

检查项:
- 算法正确性
- 边界条件
- 性能考虑

输出: 逻辑问题列表
</step2>

<!-- 步骤 3: 安全审查 -->
<step3>
<task>检查安全漏洞</task>
<code>[代码内容]</code>

检查项:
- SQL 注入
- XSS 漏洞
- 敏感数据处理

输出: 安全问题列表
</step3>

<!-- 步骤 4: 生成报告 -->
<step4>
<task>汇总审查结果</task>

<input>
质量问题: [步骤 1 输出]
逻辑问题: [步骤 2 输出]
安全问题: [步骤 3 输出]
</input>

生成结构化审查报告:
- 总体评分
- 关键问题
- 改进建议
- 优先级排序
</step4>
```

### 示例 2: 内容创作流程

```xml
<!-- 步骤 1: 研究和大纲 -->
<step1>
主题: 如何提高团队协作效率

任务:
1. 列出 5-7 个关键要点
2. 为每个要点提供简短说明
3. 确定逻辑顺序

输出: 结构化大纲
</step1>

<!-- 步骤 2: 扩展内容 -->
<step2>
基于以下大纲，为每个要点撰写 200-300 字的内容:
[步骤 1 的大纲]

要求:
- 包含具体例子
- 提供可行建议
- 保持连贯性

输出: 完整草稿
</step2>

<!-- 步骤 3: 优化和润色 -->
<step3>
优化以下草稿:
[步骤 2 的草稿]

优化方向:
- 改进开头，吸引读者
- 增强段落间的过渡
- 添加小标题
- 优化句子结构

输出: 优化后的文章
</step3>

<!-- 步骤 4: 添加元素 -->
<step4>
为文章添加辅助元素:
[步骤 3 的文章]

添加:
- 吸引人的标题 (3 个候选)
- 引言摘要 (50 字)
- 关键要点总结 (bullet points)
- 行动建议清单

输出: 最终版本
</step4>
```

### 示例 3: 数据分析管道

```xml
<!-- 步骤 1: 数据验证 -->
<step1>
<data>[原始数据]</data>

验证任务:
1. 检查数据类型
2. 识别缺失值
3. 发现异常值
4. 验证数据范围

输出: 数据质量报告 + 清洗后的数据
</step1>

<!-- 步骤 2: 探索性分析 -->
<step2>
<clean_data>[步骤 1 的清洗数据]</clean_data>

分析任务:
1. 计算描述性统计
2. 分析分布特征
3. 检测相关性
4. 识别模式

输出: 统计摘要 + 初步发现
</step2>

<!-- 步骤 3: 深度分析 -->
<step3>
<data>[步骤 1 的数据]</data>
<insights>[步骤 2 的发现]</insights>

深度分析:
1. 基于初步发现，进行假设检验
2. 分析因果关系
3. 进行分组比较
4. 时间序列分析 (如适用)

输出: 详细分析结果
</step3>

<!-- 步骤 4: 可视化 -->
<step4>
<analysis_results>[步骤 3 的结果]</analysis_results>

创建可视化:
1. 为关键发现选择合适的图表类型
2. 设计清晰的图表布局
3. 添加注释和说明
4. 生成图表代码 (Python/matplotlib)

输出: 可视化代码和说明
</step4>

<!-- 步骤 5: 报告生成 -->
<step5>
<quality_report>[步骤 1]</quality_report>
<statistics>[步骤 2]</statistics>
<analysis>[步骤 3]</analysis>
<visualizations>[步骤 4]</visualizations>

生成执行摘要报告:
- 数据概况
- 关键发现 (Top 3)
- 详细分析
- 可视化展示
- 建议和下一步

输出: Markdown 格式报告
</step5>
```

## 高级技巧

### 技巧 1: 条件分支

```xml
<step1>
评估项目风险等级: [项目描述]
输出: 低 | 中 | 高
</step1>

<step2_if_low>
如果风险=低:
使用标准流程审批
</step2_if_low>

<step2_if_medium>
如果风险=中:
需要部门经理额外审批
</step2_if_medium>

<step2_if_high>
如果风险=高:
需要完整的风险评估报告和高层审批
</step2_if_high>
```

### 技巧 2: 迭代改进

```xml
<step1>
生成初始解决方案: [问题描述]
</step1>

<step2>
评估方案: [步骤 1 的方案]
打分 (1-10) 并列出改进点
</step2>

<step3>
如果分数 < 8:
  根据改进点优化方案
  重复步骤 2
否则:
  方案通过，进入下一阶段
</step3>
```

### 技巧 3: 并行处理

```
同时发起多个独立的分析任务，然后汇总:

任务 A: 竞品分析 (可以并行)
任务 B: 用户调研 (可以并行)
任务 C: 技术评估 (可以并行)

最后汇总三个任务的结果
```

## 设计链式提示的原则

### ✅ 好的链式设计

1. **单一职责** - 每步只做一件事
2. **明确输入输出** - 清晰定义数据流
3. **可验证** - 每步结果可独立检查
4. **容错性** - 考虑错误处理
5. **模块化** - 步骤可重用和替换

### ❌ 应避免的问题

1. **步骤过细** - 不必要的拆分反而降低效率
2. **依赖不清** - 步骤间的数据流混乱
3. **过度复杂** - 分支和条件太多
4. **信息丢失** - 中间步骤丢失关键信息
5. **缺乏连贯性** - 步骤之间逻辑断裂

## 链式 vs 单一提示

### 何时使用链式？

✅ 适合链式的场景:
- 多阶段的复杂任务
- 需要中间验证的流程
- 不同步骤需要不同专长
- 输出需要高质量保证
- 任务可能需要人工干预

❌ 不适合链式的场景:
- 简单的单步任务
- 需要整体上下文的创作
- 实时性要求高的场景

## 实施技巧

### 1. 使用明确的数据传递

```xml
<!-- 好的做法 ✅ -->
<step1_output>
{
  "entities": ["人名", "地名"],
  "sentiment": "positive"
}
</step1_output>

<step2_input>
使用以下数据: [步骤 1 的输出]
</step2_input>

<!-- 不好的做法 ❌ -->
<step2>
继续上一步  // 不清楚用什么数据
</step2>
```

### 2. 添加检查点

```xml
<checkpoint>
在继续之前，验证:
- 数据格式正确 ✓
- 所有字段存在 ✓
- 数值在合理范围内 ✓
</checkpoint>
```

### 3. 提供回退机制

```xml
<step3>
尝试方法 A

如果失败:
  尝试方法 B

如果仍失败:
  使用默认方法 C
</step3>
```

## 总结

链式提示是处理复杂任务的强大方法：

- 🔗 将大任务分解为小步骤
- ✅ 每步专注单一目标
- 🎯 提高准确性和可控性
- 🔍 便于调试和优化
- 📊 支持并行和条件处理
- ⚡ 平衡复杂度和效率
